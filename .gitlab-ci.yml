include: 'https://gitlab.gnome.org/GNOME/citemplates/raw/master/flatpak/flatpak_ci_initiative.yml'

.only-origin:
  only:
    - branches@GNOME/console
  except:
    - tags

debian:
  image: debian:testing
  stage: build
  before_script:
    - apt -y update
    - apt -y install gcc g++ gettext git libgnutls28-dev libgtk-3-dev
      libsystemd-dev libgtop2-dev meson sassc desktop-file-utils appstream-util
      gsettings-desktop-schemas-dev
  script:
    - meson --buildtype=release _build .
    - ninja -C _build

fedora:
  image: fedora:latest
  stage: build
  before_script:
    - dnf update -y --nogpgcheck
    - dnf install -y --nogpgcheck meson gettext glib2-devel gcc gcc-c++ git
      desktop-file-utils gperf "pkgconfig(gtk+-3.0)" libappstream-glib
      "pkgconfig(vte-2.91)" "pkgconfig(libgtop-2.0)" "pkgconfig(fribidi)"
      "pkgconfig(gnutls)" "pkgconfig(libsystemd)" "pkgconfig(libpcre2-8)"
      "pkgconfig(gsettings-desktop-schemas)" sassc
  script:
    - meson --buildtype=release -Dtests=true _build .
    - meson compile -C _build
    - meson test -C _build

freebsd-13-x86_64:
  extends: .only-origin
  stage: build
  tags:
    - freebsd-13
  needs: []
  variables:
    CPPFLAGS: -I/usr/local/include
    LDFLAGS: -L/usr/local/lib -Wl,--disable-new-dtags
    LANG: C.UTF-8
  before_script:
    - pkg install gtk3 libgtop
  script:
    - meson --buildtype=release -Dtests=true _build .
    - meson compile -C _build
    - meson test -C _build
  artifacts:
    reports:
      junit: "_build/meson-logs/testlog.junit.xml"
    name: "kgx-${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    when: always
    expire_in: 1 week
    paths:
      - "_build/kgx-config.h"
      - "_build/meson-logs"


flatpak:
    image: 'registry.gitlab.gnome.org/gnome/gnome-runtime-images/gnome:master'
    stage: build
    variables:
        MANIFEST_PATH: "build-aux/flatpak/org.gnome.Console.Devel.json"
        FLATPAK_MODULE: "gnome-console"
        RUNTIME_REPO: "https://nightly.gnome.org/gnome-nightly.flatpakrepo"
        GIT_SUBMODULE_STRATEGY: recursive
        APP_ID: "org.gnome.Console.Devel"
        BUNDLE: "org.gnome.Console.Devel.flatpak"
    extends: .flatpak
