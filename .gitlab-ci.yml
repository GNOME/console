include: 'https://gitlab.gnome.org/GNOME/citemplates/raw/master/flatpak/flatpak_ci_initiative.yml'

debian:
  image: debian:testing
  stage: build
  before_script:
    - apt -y update
    - apt -y install gcc g++ gettext git libgnutls28-dev libgtk-4-dev
      libsystemd-dev libgtop2-dev meson desktop-file-utils appstream-util
      gsettings-desktop-schemas-dev
  script:
    - meson --buildtype=release _build .
    - ninja -C _build

fedora:
  image: fedora:latest
  stage: build
  before_script:
    - dnf update -y --nogpgcheck
    - dnf install -y --nogpgcheck meson gettext glib2-devel gcc gcc-c++ git
      desktop-file-utils gperf "pkgconfig(gtk4)" libappstream-glib
      "pkgconfig(libgtop-2.0)" "pkgconfig(fribidi)" "pkgconfig(gnutls)"
      "pkgconfig(libsystemd)" "pkgconfig(libpcre2-8)"
      "pkgconfig(gsettings-desktop-schemas)"
  script:
    - meson --buildtype=release -Dtests=true _build .
    - meson compile -C _build
    - meson test -C _build

flatpak:
    stage: build
    variables:
        MANIFEST_PATH: "build-aux/flatpak/org.gnome.Console.Devel.json"
        FLATPAK_MODULE: "gnome-console"
        RUNTIME_REPO: "https://nightly.gnome.org/gnome-nightly.flatpakrepo"
        GIT_SUBMODULE_STRATEGY: recursive
        APP_ID: "org.gnome.Console.Devel"
        BUNDLE: "org.gnome.Console.Devel.flatpak"
    extends: .flatpak
